(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[783],{4023:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat/[matchId]",function(){return s(9226)}])},9226:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return u}});var a=s(5893),r=s(7294),o=s(1163),n=s(9828),l=s(3977),i=s(6689);let c=(0,l.ZF)({apiKey:"AIzaSyBh5ET8InC-485lsXIwoeyMOpNlwHMTEB0",authDomain:"fightmatch-45bf4.firebaseapp.com",projectId:"fightmatch-45bf4",storageBucket:"fightmatch-45bf4.firebasestorage.app",messagingSenderId:"897012307107",appId:"1:897012307107:web:ccdfc963cf572a1ae05b16",measurementId:"G-WKBYC9BL4T"}),d=(0,n.ad)(c);function u(){let e=(0,o.useRouter)(),{matchId:t}=e.query,[s,l]=(0,r.useState)([]),[i,c]=(0,r.useState)(""),[u,m]=(0,r.useState)(!1),[g,h]=(0,r.useState)(null),f=(0,r.useRef)(null),p=()=>{var e;null===(e=f.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};(0,r.useEffect)(()=>{p()},[s]),(0,r.useEffect)(()=>{if(console.log("\uD83D\uDD25 Listener useEffect triggered"),console.log("matchId:",t),!t){console.log("❌ No matchId, exiting");return}let e=parseInt(localStorage.getItem("user_id"));if(console.log("currentUserId:",e),!e){console.error("❌ No user_id in localStorage");return}let s="chat_".concat(Math.min(e,parseInt(t)),"_").concat(Math.max(e,parseInt(t)));console.log("\uD83D\uDCDD Conversation ID:",s),console.log("\uD83D\uDD25 Firebase db object:",d);try{let e=(0,n.hJ)(d,"conversations",s,"messages");console.log("\uD83D\uDCDA Messages ref created:",e);let t=(0,n.IO)(e,(0,n.Xo)("timestamp","asc"));console.log("\uD83D\uDD0D Query created");let a=(0,n.cf)(t,e=>{console.log("✅ Snapshot received! Size:",e.size);let t=[];e.forEach(e=>{var s;let a=e.data();console.log("\uD83D\uDCC4 Message doc:",e.id,a),t.push({id:e.id,...a,timestamp:null===(s=a.timestamp)||void 0===s?void 0:s.toDate()})}),console.log("\uD83D\uDCAC Total messages:",t.length),l(t)},e=>{console.error("❌ Error listening to messages:",e)});return console.log("✅ Listener set up successfully"),()=>{console.log("\uD83E\uDDF9 Cleaning up listener"),a()}}catch(e){console.error("❌ Error setting up listener:",e)}},[t]),(0,r.useEffect)(()=>{if(!t)return;let e=parseInt(localStorage.getItem("user_id"));if(!e){console.error("No user_id in localStorage");return}let s="chat_".concat(Math.min(e,parseInt(t)),"_").concat(Math.max(e,parseInt(t))),a=(0,n.hJ)(d,"conversations",s,"messages"),r=(0,n.IO)(a,(0,n.Xo)("timestamp","asc")),o=(0,n.cf)(r,e=>{let t=[];e.forEach(e=>{var s;let a=e.data();t.push({id:e.id,...a,timestamp:null===(s=a.timestamp)||void 0===s?void 0:s.toDate()})}),l(t)},e=>{console.error("Error listening to messages:",e)});return()=>o()},[t]);let x=async()=>{if(i.trim()){m(!0);try{let e=localStorage.getItem("access_token"),s=await fetch("https://fightmatch-backend.onrender.com/messages/send",{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify({match_id:parseInt(t),content:i})});if(s.ok)c("");else{let e=await s.json();alert(e.detail||"Failed to send message")}}catch(e){console.error("Error sending message:",e),alert("Failed to send message")}finally{m(!1)}}},b=parseInt(localStorage.getItem("user_id"));return(0,a.jsxs)("div",{className:"min-h-screen bg-gray-900 flex flex-col",children:[(0,a.jsx)("div",{className:"bg-gray-800 p-4 border-b border-gray-700",children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto flex items-center gap-4",children:[(0,a.jsx)("button",{onClick:()=>e.back(),className:"text-white hover:text-gray-300",children:"← Back"}),g&&(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[g.profile_pic&&(0,a.jsx)("img",{src:g.profile_pic,alt:g.username,className:"w-10 h-10 rounded-full object-cover"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-white font-semibold",children:g.username}),(0,a.jsx)("p",{className:"text-gray-400 text-sm",children:g.skill_level})]})]})]})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto space-y-4",children:[0===s.length?(0,a.jsx)("div",{className:"text-center text-gray-500 py-8",children:"No messages yet. Start the conversation! \uD83E\uDD4A"}):s.map(e=>{let t=e.sender_id===b;return(0,a.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ".concat(t?"bg-red-600 text-white rounded-br-none":"bg-gray-700 text-white rounded-bl-none"),children:[!t&&(0,a.jsx)("p",{className:"text-xs text-gray-300 mb-1 font-semibold",children:e.sender_name}),(0,a.jsx)("p",{className:"break-words",children:e.content}),e.timestamp&&(0,a.jsx)("p",{className:"text-xs text-gray-300 mt-1 opacity-70",children:e.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},e.id)}),(0,a.jsx)("div",{ref:f})]})}),(0,a.jsx)("div",{className:"bg-gray-800 p-4 border-t border-gray-700",children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto flex gap-2",children:[(0,a.jsx)("input",{type:"text",value:i,onChange:e=>c(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),x())},placeholder:"Type a message...",disabled:u,className:"flex-1 bg-gray-700 text-white rounded-full px-6 py-3 focus:outline-none focus:ring-2 focus:ring-red-600"}),(0,a.jsx)("button",{onClick:x,disabled:!i.trim()||u,className:"bg-red-600 text-white px-8 py-3 rounded-full hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors font-semibold",children:u?"Sending...":"Send"})]})})]})}(0,i.cF)(c)}},function(e){e.O(0,[703,38,888,774,179],function(){return e(e.s=4023)}),_N_E=e.O()}]);